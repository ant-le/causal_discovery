# @package _global_
# BCNP "All Data" training regime (paper replication).
name: "bcnp_paper"

logger:
  wandb:
    enabled: true
    project: "causal_meta"
    tags: ["bcnp", "paper", "all_data"]

data:
  # -------------------------------------------------------------------------
  # TRAINING FAMILY: BCNP "All Data" mixture
  # -------------------------------------------------------------------------
  train_family:
    name: bcnp_all_data_train
    n_nodes: 20

    # Graph: Mixture of ER (multi-density) and SF (hubs)
    graph_cfg:
      type: mixture
      weights: [0.1667, 0.1667, 0.1667, 0.5]
      generators:
        - type: er
          sparsity: 0.0526 # Expected edges ~20 for n_nodes=20
        - type: er
          sparsity: 0.1053 # Expected edges ~40 for n_nodes=20
        - type: er
          sparsity: 0.1579 # Expected edges ~60 for n_nodes=20
        - type: sf
          m: 2

    # Mechanisms: Balanced mixture of Linear, MLP, GP (GPCDE proxy)
    mech_cfg:
      type: mixture
      weights: [0.34, 0.33, 0.33]
      factories:
        - type: linear
          weight_scale: 10.0
          noise_concentration: 2.0
          noise_rate: 2.0
        - type: mlp
          hidden_dim: 32
        - type: gp
          rff_dim: 256
          length_scale_range: [0.5, 2.0]
          variance: 1.0

  # -------------------------------------------------------------------------
  # VALIDATION (In-Distribution)
  # -------------------------------------------------------------------------
  val_families:
    id_val:
      name: id_val
      n_nodes: 20
      graph_cfg:
        type: er
        sparsity: 0.2
      mech_cfg:
        type: linear
        weight_scale: 10.0

  # -------------------------------------------------------------------------
  # TEST (In-Distribution default, override with audit configs)
  # -------------------------------------------------------------------------
  test_families:
    id_test:
      name: id_test
      n_nodes: 20
      graph_cfg:
        type: er
        sparsity: 0.2
      mech_cfg:
        type: linear
        weight_scale: 10.0

  seeds_val: [1000, 1001, 1002, 1003, 1004]
  seeds_test: [2000, 2001, 2002, 2003, 2004]
  base_seed: 42
  samples_per_task: 256
  safety_checks: true
  num_workers: 4
  pin_memory: true
  normalize_data: true
  batch_size_train: 1
  batch_size_val: 1
  batch_size_test: 1
  batch_size_test_interventional: 1

model:
  type: "bcnp"
  num_nodes: 20
  d_model: 128
  nhead: 8
  num_layers: 4
  num_layers_decoder: 4
  dim_feedforward: 512
  dropout: 0.1
  emb_depth: 2
  use_positional_encoding: false
  n_perm_samples: 10
  sinkhorn_iter: 20
  q_before_l: true

trainer:
  lr: 0.0001
  weight_decay: 1e-4
  accumulate_grad_batches: 1
  max_steps: 100000
  log_every_n_steps: 100
  val_check_interval: 1000
  checkpoint_every_n_steps: 1000
  grad_clip_norm: 1.0
  amp: false

inference:
  n_samples: 20

hydra:
  run:
    dir: ${oc.env:CAUSAL_META_RUN_DIR,experiments/runs/${name}/${now:%Y-%m-%d}/${now:%H-%M-%S}}
  sweep:
    dir: ${oc.env:CAUSAL_META_SWEEP_DIR,experiments/runs/${name}/multirun/${now:%Y-%m-%d}/${now:%H-%M-%S}}
    subdir: ${hydra.job.num}
