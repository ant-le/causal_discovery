# @package _global_
# Larger local run for BCNP on a single machine (CPU/MPS/CUDA).

name: "bcnp_large"

logger:
  wandb:
    enabled: true
    mode: "online"
    project: "causal_meta"
    entity: "lechuga-anton"
    name: "${name}"
    tags: ["bcnp", "local", "large"]

data:
  # -------------------------------------------------------------------------
  # TRAINING FAMILY: The "Competence" Mixture (from train_competence.yaml)
  # -------------------------------------------------------------------------
  train_family:
    name: competence_train
    n_nodes: 20

    # Graph: Mixture of ER (Sparse) and SF (Hubs)
    graph_cfg:
      type: mixture
      weights: [0.5, 0.5]
      generators:
        - type: er
          sparsity: 0.2 # Expected deg ~ 4
        - type: sf
          m: 2 # Preferential attachment

    # Mechanisms: Mixture of Linear, MLP, GP
    mech_cfg:
      type: mixture
      weights: [0.34, 0.33, 0.33]
      factories:
        - type: linear
          weight_scale: 1.0
          noise_concentration: 2.0 # Heteroscedasticity
        - type: mlp
          hidden_dim: 32
        - type: gp
          rff_dim: 256
          length_scale_range: [0.5, 2.0]

  # -------------------------------------------------------------------------
  # VALIDATION (In-Distribution) (from train_competence.yaml)
  # -------------------------------------------------------------------------
  val_families:
    id_val:
      name: id_val
      n_nodes: 20
      graph_cfg:
        type: er
        sparsity: 0.2
      mech_cfg:
        type: linear

  # -------------------------------------------------------------------------
  # TEST FAMILIES (Full Audit Suite from full_audit.yaml)
  # -------------------------------------------------------------------------
  test_families:
    # ID Test (from train_competence defaults)
    id_test:
      name: id_test
      n_nodes: 20
      graph_cfg:
        type: er
        sparsity: 0.2
      mech_cfg:
        type: linear

    # 1. Functional Shifts (Square, Periodic)
    ood_square:
      name: ood_square
      n_nodes: 20
      graph_cfg:
        type: er
        sparsity: 0.2
      mech_cfg:
        type: square
        weight_scale: 1.0
        noise_scale: 0.1

    ood_periodic:
      name: ood_periodic
      n_nodes: 20
      graph_cfg:
        type: er
        sparsity: 0.2
      mech_cfg:
        type: periodic
        weight_scale: 1.0
        noise_scale: 0.1

    # 2. Chaos (Logistic Map)
    ood_logistic_map:
      name: ood_logistic_map
      n_nodes: 20
      graph_cfg:
        type: er
        sparsity: 0.2
      mech_cfg:
        type: logistic_map
        weight_scale: 1.0

    # 3. Post-Nonlinear (PNL)
    ood_pnl_cube:
      name: ood_pnl_cube
      n_nodes: 20
      graph_cfg:
        type: er
        sparsity: 0.2
      mech_cfg:
        type: pnl
        nonlinearity_type: cube
        inner_config:
          type: linear

    ood_pnl_sigmoid:
      name: ood_pnl_sigmoid
      n_nodes: 20
      graph_cfg:
        type: er
        sparsity: 0.2
      mech_cfg:
        type: pnl
        nonlinearity_type: sigmoid
        inner_config:
          type: linear

    ood_pnl_tanh:
      name: ood_pnl_tanh
      n_nodes: 20
      graph_cfg:
        type: er
        sparsity: 0.2
      mech_cfg:
        type: pnl
        nonlinearity_type: tanh
        inner_config:
          type: linear

    # 4. Structural (SBM)
    ood_sbm_strong:
      name: ood_sbm_strong
      n_nodes: 20
      graph_cfg:
        type: sbm
        n_blocks: 4
        p_intra: 0.6
        p_inter: 0.01 # Very sparse connections between blocks
      mech_cfg:
        type: linear

    ood_sbm_weak:
      name: ood_sbm_weak
      n_nodes: 20
      graph_cfg:
        type: sbm
        n_blocks: 4
        p_intra: 0.3
        p_inter: 0.1
      mech_cfg:
        type: linear

    # 5. References
    ref_linear:
      name: ref_linear
      n_nodes: 20
      graph_cfg:
        type: er
        sparsity: 0.2
      mech_cfg:
        type: linear

    ref_gp:
      name: ref_gp
      n_nodes: 20
      graph_cfg:
        type: er
        sparsity: 0.2
      mech_cfg:
        type: gp

  # Seeds and other data configs
  seeds_val: [1000, 1001, 1002, 1003, 1004]
  seeds_test:
    [
      2000,
      2001,
      2002,
      2003,
      2004,
      2005,
      2006,
      2007,
      2008,
      2009,
      2010,
      2011,
      2012,
      2013,
      2014,
      2015,
      2016,
      2017,
      2018,
      2019,
    ]
  samples_per_task: 256
  num_workers: 0
  pin_memory: false
  batch_size_train: 1
  batch_size_val: 1
  batch_size_test: 1
  batch_size_test_interventional: 1

  # From train_competence.yaml
  base_seed: 42
  safety_checks: true

model:
  type: "bcnp"
  num_nodes: 20
  d_model: 128
  nhead: 8
  num_layers: 4
  num_layers_decoder: 4
  dim_feedforward: 512
  dropout: 0.1
  emb_depth: 2
  use_positional_encoding: false
  n_perm_samples: 10
  sinkhorn_iter: 20
  q_before_l: true

trainer:
  lr: 0.0001
  weight_decay: 1e-4
  accumulate_grad_batches: 1
  max_steps: 20000
  log_every_n_steps: 100
  val_check_interval: 2000
  checkpoint_every_n_steps: 2000
  amp: false
  grad_clip_norm: 1.0
  scheduler: cosine
  scheduler_t_max: 20000
  scheduler_eta_min: 0.0

# Used for validation during pre-training and for final evaluation sampling.
inference:
  n_samples: 20

hydra:
  run:
    dir: ${oc.env:CAUSAL_META_RUN_DIR,experiments/runs/${name}/${now:%Y-%m-%d}/${now:%H-%M-%S}}
  sweep:
    dir: ${oc.env:CAUSAL_META_SWEEP_DIR,experiments/runs/${name}/multirun/${now:%Y-%m-%d}/${now:%H-%M-%S}}
    subdir: ${hydra.job.num}
